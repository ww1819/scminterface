<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scminterface.framework.web.mapper.SpdScheduledTaskMapper">

    <!-- 查询定时任务配置（按任务名称） -->
    <select id="selectByTaskName" parameterType="String" resultType="java.util.HashMap">
        select 
            task_id as taskId,
            task_name as taskName,
            task_class as taskClass,
            task_method as taskMethod,
            cron_expression as cronExpression,
            max_exec_count as maxExecCount,
            current_exec_count as currentExecCount,
            status,
            create_time as createTime,
            update_time as updateTime
        from spd_scheduled_task
        where task_name = #{taskName}
        limit 1
    </select>

    <!-- 查询定时任务配置（按类和方法） -->
    <select id="selectByClassAndMethod" resultType="java.util.HashMap">
        select 
            task_id as taskId,
            task_name as taskName,
            task_class as taskClass,
            task_method as taskMethod,
            cron_expression as cronExpression,
            max_exec_count as maxExecCount,
            current_exec_count as currentExecCount,
            status,
            create_time as createTime,
            update_time as updateTime
        from spd_scheduled_task
        where task_class = #{taskClass} and task_method = #{taskMethod}
        limit 1
    </select>

    <!-- 查询所有定时任务 -->
    <select id="selectAll" resultType="java.util.HashMap">
        select 
            task_id as taskId,
            task_name as taskName,
            task_class as taskClass,
            task_method as taskMethod,
            cron_expression as cronExpression,
            max_exec_count as maxExecCount,
            current_exec_count as currentExecCount,
            status,
            create_time as createTime,
            update_time as updateTime
        from spd_scheduled_task
        order by task_class, task_method
    </select>

    <!-- 插入定时任务 -->
    <insert id="insertTask" parameterType="java.util.HashMap" useGeneratedKeys="true" keyProperty="taskId">
        insert into spd_scheduled_task(
            task_name,
            task_class,
            task_method,
            cron_expression,
            max_exec_count,
            current_exec_count,
            status,
            create_time,
            update_time
        )values(
            #{taskName},
            #{taskClass},
            #{taskMethod},
            #{cronExpression},
            #{maxExecCount},
            0,
            #{status},
            now(),
            now()
        )
    </insert>

    <!-- 更新定时任务配置 -->
    <update id="updateTask" parameterType="java.util.HashMap">
        update spd_scheduled_task
        <set>
            <if test="taskName != null and taskName != ''">task_name = #{taskName},</if>
            <if test="cronExpression != null and cronExpression != ''">cron_expression = #{cronExpression},</if>
            <if test="maxExecCount != null">max_exec_count = #{maxExecCount},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            update_time = now()
        </set>
        <where>
            <if test="taskName != null and taskName != ''">
                task_name = #{taskName}
            </if>
            <if test="taskClass != null and taskClass != '' and taskMethod != null and taskMethod != ''">
                task_class = #{taskClass} and task_method = #{taskMethod}
            </if>
        </where>
    </update>

    <!-- 删除定时任务 -->
    <delete id="deleteTask">
        delete from spd_scheduled_task
        where task_class = #{taskClass} and task_method = #{taskMethod}
    </delete>

    <!-- 增加执行次数（按任务名称） -->
    <update id="incrementExecCount" parameterType="String">
        update spd_scheduled_task
        set current_exec_count = current_exec_count + 1,
            update_time = now()
        where task_name = #{taskName}
    </update>

    <!-- 增加执行次数（按类和方法） -->
    <update id="incrementExecCountByClassAndMethod">
        update spd_scheduled_task
        set current_exec_count = current_exec_count + 1,
            update_time = now()
        where task_class = #{taskClass} and task_method = #{taskMethod}
    </update>

    <!-- 重置执行次数（按任务名称） -->
    <update id="resetExecCount" parameterType="String">
        update spd_scheduled_task
        set current_exec_count = 0,
            update_time = now()
        where task_name = #{taskName}
    </update>

    <!-- 重置执行次数（按类和方法） -->
    <update id="resetExecCountByClassAndMethod">
        update spd_scheduled_task
        set current_exec_count = 0,
            update_time = now()
        where task_class = #{taskClass} and task_method = #{taskMethod}
    </update>

</mapper>
